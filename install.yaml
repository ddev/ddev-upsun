name: upsun

project_files:
  - upsun/install-hook.php
  - upsun/UpsunConfigParser.php
  - upsun/DdevConfigGenerator.php
  - upsun/debug-parser.php

post_install_actions:
  - |
    <?php
    # #ddev-description Initialize Upsun configuration
    require_once('upsun/install-hook.php');
  - |
    <?php
    # #ddev-description Debug Upsun configuration parsing
    # require_once('upsun/debug-parser.php');

removal_actions:
  - |
    <?php
    # #ddev-description Remove Upsun-generated files
    echo "=== Upsun add-on removal cleanup ===\n";
    $files_to_remove = [
      'config.upsun.yaml',
      'web-build/Dockerfile.upsun',
      '.env.upsun-services'
    ];
    
    foreach ($files_to_remove as $file) {
      if (file_exists($file)) {
        $content = file_get_contents($file);
        $isGenerated = strpos($content, '#ddev-generated') !== false || 
                      strpos($content, '# Upsun service versions (auto-generated') !== false;
        
        if ($isGenerated) {
          if (unlink($file)) {
            echo "✅ Removed: $file\n";
          } else {
            echo "❌ Failed to remove: $file\n";
          }
        } else {
          echo "⚠️  Skipped: $file (not auto-generated)\n";
        }
      } else {
        echo "ℹ️  Not found: $file\n";
      }
    }
    
    // Clean up empty web-build directory
    if (is_dir('web-build')) {
      $files = array_diff(scandir('web-build'), ['.', '..']);
      if (empty($files)) {
        if (rmdir('web-build')) {
          echo "✅ Removed empty directory: web-build\n";
        }
      }
    }
    echo "=== Cleanup completed ===\n";

ddev_version_constraint: '>= v1.24.3'
